# KumoRailT中文文档

嗯，首先恭喜你发现这个用中文写成的文档，而不用去看作者自己也看不懂的英文（笑）

KumoRailT 是一个新的版本的KumoRail。是微信公众号KumoRail的后端程序。这个公众号的目标是为铁路旅行的乘客提供尽可能多的便利信息。这个公众号现在包含正晚点历史查询、动车组配属查询、动车组交路查询、车站电报码查询等功能。用户可以通过直接发送相关查询语句的方式来获取想要的信息。从而不用再去使用繁琐的客户端和网页。

KumoRail时期，整体的架构为Flask+MongoDB，后期为了提高性能以及方便的建构数据，把服务器框架换成了高并发的Tornado，把DBMS换成了SQL型数据库。但是我也想保留原来的版本作为一个单独的项目，所以把这个新结构的程序取名为了KumoRailT。其实其提供的功能都是大同小异的。

## 使用方法

1. 正晚点查询相关：发送“车次+车站”获取若干天内该车次到该车站的实际到点历史；发送“wa+车次”获取最新发出的一趟车的正晚点状态；发送“all”查看所有在监控的车次。因为车次需要添加监控之后，我们才会去获取它的状态，所以如果您想要看到什么车次的话，请联系管理员。

2. 动车组配属：发送“ps+车组号”来查看该车组的配属情况。例如“ps1002”

3. 交路查询相关：直接发送车次，就可以获取到该车次的交路和时刻信息。例如：“G1001”。发送“jl+车次”可以只查询该车次的交路信息。发送“sk+车次”可以只查询时刻信息。

4. 车站电报码：发送“db+车站首字母简写”查询车站的电报码。例如“dbbjx”可以查到北京西的。

## 如何部署

(待补充)
1. 从GitHub上下载该程序

2. 配置Python virtualenv以及相关Package。

3. 配置Supervisord以及Nginx

4. 调试与启动

## 二次开发指南

### 代码简述

程序包含5个部分：数据库接口模块（DB Interface）；服务主进程（Request Handler）；讯息分析其回复模块（Message Handler）；数据抓取模块（Hook）；其他的Tools。

数据库接口模块提供了操作数据库的类，通过引用类，可以对各个表进行增、删、查、验等操作。类名为Table。Code为于dbmaria/目录下，其中dbmaria2.py为底层，负责SQL语句的生成和对PyMySQL库的直接调用。然后dpb1-dbp5中定义了对列车相关数据的Table进行操作的类。dblog服务于讯息分析和回复模块，为其记录收到和回复的消息。dbproxy提供proxy的储存和取用服务。此两者使用方法和dbp系列相同。

服务主进程（Code在server.py）通过Tornado框架来接收处理端口传入的请求，传递给相应的HRL Handler。真正起作用的是wxHandler。它使用微信提供的库来对请求体进行拆包和解密。被拆解之后的消息本体会被传入到Message Handler，最终得到一个回复信息。回复信息会再经由这里进行加密和封包，送还给Client。如果发生错误，也会送还相关的讯息。

讯息分析及回复模块接受传入的消息（即为用户对于bot发送的消息），然后分析其查询类别，进行相关的查询，组织回复语句，之后回传给服务主进程。其主要包括parse和hlsearch两部分，负责分析和查询。

Hook数据抓取模块是通过独立启动或者被调用的方式来获取数据的。除了depotHook因不保存配属数据，故会在查询时被实时调用之外，其他的Hook都是独立启动以获取数据。train、seq、proxy几个Hook是由本地文件获取数据，actHook为在线获取。arrHook为持续运行的在线获取。

Tools为其他相关的辅助模块。